name: Coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run tests with coverage
      run: pnpm test:coverage

    - name: Generate coverage badge
      run: node scripts/generate-coverage-badge.js

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

    - name: Coverage Badge
      uses: tj-actions/coverage-badge-js@v1
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        coverage-file: './coverage/coverage-summary.json'

    - name: Verify Changed files
      uses: tj-actions/verify-changed-files@v12
      id: verify-changed-files
      with:
        files: coverage-badge.json

    - name: Create Coverage Badge
      if: steps.verify-changed-files.outputs.files_changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "docs: update coverage badge"
        title: "ðŸ“Š Update Coverage Badge"
        body: |
          ## Coverage Report Update

          This PR updates the coverage badge based on the latest test results.

          **Coverage Summary:**
          - Statements: ${{ env.COVERAGE_STATEMENTS }}%
          - Branches: ${{ env.COVERAGE_BRANCHES }}%
          - Functions: ${{ env.COVERAGE_FUNCTIONS }}%
          - Lines: ${{ env.COVERAGE_LINES }}%

          Auto-generated by GitHub Actions.
        branch: update-coverage-badge
